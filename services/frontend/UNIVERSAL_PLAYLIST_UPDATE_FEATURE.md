# Universal Playlist Update Feature

## Обзор

Новая система универсального обновления плейлистов позволяет добавлять информацию к трекам из множественных внешних источников. Система поддерживает пошаговый процесс выбора источника данных и обработки результатов.

## Компоненты

### UniversalPlaylistUpdate

Основной компонент для универсального обновления плейлистов.

**Функциональность:**
- Пошаговый интерфейс выбора источника данных
- Поддержка Spotify распознавания
- Поддержка загрузки M3U файлов
- Отображение прогресса обработки
- Детальные результаты обновления

**Шаги процесса:**
1. **Выбор источника** - пользователь выбирает тип данных для добавления
2. **Обработка** - выполняется поиск/парсинг данных
3. **Результаты** - отображается информация о результатах

### TrackEditDialog (обновленный)

Диалог редактирования трека с поддержкой табов для разных источников данных.

**Табы:**
- **Общая информация** - основные поля трека (название, исполнитель, альбом)
- **Spotify** - поиск и привязка к Spotify трекам
- **Данные файла** - редактирование M3U данных (путь, длительность)

## Источники данных

### Spotify
- Поиск треков по артисту и названию
- Точное сопоставление для автоматической привязки
- Поддержка поиска по URL
- Отображение результатов поиска с обложками

### M3U файлы
- Загрузка .m3u и .m3u8 файлов
- Парсинг путей к файлам и метаданных
- Сопоставление треков по артисту и названию
- Добавление информации о путях к файлам

## Логика сопоставления

### Spotify сопоставление
```typescript
// Точное совпадение по артисту и названию
const isExactMatch = (track: Track, spotifyTrack: SpotifyTrackData): boolean => {
  const trackKey = `${track.artist.toLowerCase().trim()}-${track.title.toLowerCase().trim()}`;
  const spotifyKey = `${spotifyTrack.artists[0]?.name.toLowerCase().trim()}-${spotifyTrack.name.toLowerCase().trim()}`;
  return trackKey === spotifyKey;
};
```

### M3U сопоставление
```typescript
// Сопоставление треков в M3U файле
const matchingM3UTrack = m3uTracks.find((m3uTrack) => {
  const trackKey = `${track.artist.toLowerCase().trim()}-${track.title.toLowerCase().trim()}`;
  const m3uKey = `${m3uTrack.artist.toLowerCase().trim()}-${m3uTrack.title.toLowerCase().trim()}`;
  return trackKey === m3uKey;
});
```

## Структура данных

### UpdateResult
```typescript
interface UpdateResult {
  updated: Track[];      // Обновленные треки
  skipped: Track[];      // Пропущенные треки
  total: number;         // Общее количество обработанных треков
  source: 'spotify' | 'm3u'; // Источник данных
}
```

### UpdateStep
```typescript
type UpdateStep = 'select' | 'spotify' | 'm3u' | 'result';
```

## Пользовательский интерфейс

### Шаг 1: Выбор источника
- Карточки с описанием каждого источника
- Визуальные иконки для каждого типа данных
- Hover эффекты для интерактивности

### Шаг 2: Обработка
- Индикатор прогресса
- Описание текущего действия
- Возможность отмены операции

### Шаг 3: Результаты
- Список обновленных треков
- Список пропущенных треков
- Статистика обработки
- Кнопка закрытия

## Интеграция

### Замена BatchSpotifyRecognition
Новый компонент `UniversalPlaylistUpdate` заменяет старый `BatchSpotifyRecognition`:

```typescript
// Старый импорт
import { BatchSpotifyRecognition } from '../BatchSpotifyRecognition';

// Новый импорт
import UniversalPlaylistUpdate from '../UniversalPlaylistUpdate/UniversalPlaylistUpdate';

// Использование
<UniversalPlaylistUpdate tracks={tracks} />
```

### Обновление TrackEditDialog
Диалог редактирования трека теперь поддерживает табы:

```typescript
// Новые табы
const [activeTab, setActiveTab] = useState<'general' | 'spotify' | 'm3u'>('general');
```

## Расширяемость

Система разработана с учетом будущего расширения:

### Добавление новых источников
1. Добавить новый тип в `UpdateStep`
2. Создать функцию обработки для нового источника
3. Добавить UI для нового шага
4. Обновить логику сопоставления

### Пример добавления YouTube
```typescript
type UpdateStep = 'select' | 'spotify' | 'm3u' | 'youtube' | 'result';

// Добавить обработку YouTube
const handleYouTubeUpdate = async () => {
  // Логика обработки YouTube данных
};
```

## Преимущества новой системы

1. **Универсальность** - поддержка множественных источников
2. **Пошаговость** - понятный процесс для пользователя
3. **Расширяемость** - легко добавлять новые источники
4. **Детальная отчетность** - полная информация о результатах
5. **Улучшенный UX** - современный интерфейс с прогресс-барами

## Миграция

### Автоматическая замена
- `BatchSpotifyRecognition` → `UniversalPlaylistUpdate`
- Старая функциональность полностью сохранена
- Новые возможности доступны сразу

### Обратная совместимость
- Все существующие функции работают как прежде
- API компонентов не изменился
- Данные сохраняются в том же формате 