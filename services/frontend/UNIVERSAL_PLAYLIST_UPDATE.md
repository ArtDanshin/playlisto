# Универсальное обновление плейлистов

## Обзор изменений

Мы перенесли функционал обновления плейлиста из сайдбара в основное окно просмотра треков и добавили поддержку различных источников данных.

## Основные изменения

### 1. Перенос кнопки обновления

**Было**: Кнопка обновления плейлиста находилась в сайдбаре рядом с каждым плейлистом
**Стало**: Кнопка обновления плейлиста находится в основном окне просмотра треков

### 2. Поддержка множественных источников

**Было**: Только загрузка из M3U файлов
**Стало**: Поддержка файлов M3U и импорт из Spotify

### 3. Универсальные диалоги

Созданы новые компоненты для работы с различными источниками:

#### UniversalUpdatePlaylistDialog
- Выбор источника (файл или Spotify)
- Загрузка файлов M3U/M3U8
- Импорт плейлистов из Spotify по ссылке
- Настройки синхронизации
- Предварительный просмотр изменений

#### UniversalAddPlaylistDialog
- Выбор источника для добавления нового плейлиста
- Загрузка файлов M3U/M3U8
- Импорт плейлистов из Spotify по ссылке

## Новые компоненты

### SourceSelectionDialog
Компонент для выбора источника данных:
- Файл M3U (.m3u, .m3u8)
- Spotify (по ссылке на плейлист)

### SpotifyPlaylistImportDialog
Компонент для импорта плейлистов из Spotify:
- Валидация ссылок на плейлисты
- Автоматическое сохранение обложек
- Обработка ошибок авторизации

### UniversalUpdatePlaylistDialog
Универсальный диалог обновления плейлиста:
- Выбор источника данных
- Загрузка и обработка файлов
- Импорт из Spotify
- Настройки синхронизации
- Предварительный просмотр изменений

### UniversalAddPlaylistDialog
Универсальный диалог добавления плейлиста:
- Выбор источника данных
- Загрузка файлов M3U
- Импорт из Spotify

## Логика сопоставления треков

### Для файлов M3U
Сопоставление происходит по ключу `artist + title`:
```typescript
const trackKey = createTrackKey(track); // artist + title
```

### Для Spotify
Сопоставление происходит по `spotifyData.id`:
```typescript
// При наличии spotifyData.id используется он
// Иначе используется artist + title
```

## Настройки синхронизации

### Добавить новые треки
Добавляет треки, которых нет в текущем плейлисте

### Удалить отсутствующие треки
Удаляет треки, которых нет в загруженном плейлисте

### Синхронизировать порядок треков
Обновляет порядок треков в соответствии с загруженным плейлистом

## Обработка данных из разных источников

### M3U файлы
- Парсинг файлов .m3u и .m3u8
- Извлечение названия, исполнителя, URL и длительности
- Сохранение в `m3uData`

### Spotify
- Получение данных через Spotify API
- Извлечение названия, исполнителя, альбома, обложки
- Автоматическое сохранение обложек в base64
- Сохранение в `spotifyData`

## Заполнение полей треков

### Основные поля
- `title` - из первого доступного источника
- `artist` - из первого доступного источника  
- `album` - из первого доступного источника
- `position` - порядковый номер в плейлисте

### Данные источников
- `m3uData` - для треков из M3U файлов
- `spotifyData` - для треков из Spotify
- `coverKey` - ключ обложки в базе данных

## Интерфейс

### Кнопка обновления в основном окне
```typescript
<UniversalUpdatePlaylistDialog
  currentPlaylist={currentPlaylist}
  onPlaylistUpdated={updatePlaylist}
>
  <Button variant='outline' size='sm'>
    <RefreshCw className='mr-2 h-4 w-4' />
    Обновить плейлист
  </Button>
</UniversalUpdatePlaylistDialog>
```

### Кнопка добавления в сайдбаре
```typescript
<UniversalAddPlaylistDialog onPlaylistAdded={handlePlaylistUploaded}>
  <Button className='w-full'>
    <Plus className='mr-2 h-4 w-4' />
    Добавить плейлист
  </Button>
</UniversalAddPlaylistDialog>
```

## Будущие расширения

Архитектура позволяет легко добавлять новые источники данных:

1. Создать новый компонент импорта для источника
2. Добавить тип источника в `SourceType`
3. Обновить логику сопоставления треков
4. Добавить обработку специфичных данных источника

## Примеры использования

### Обновление из файла
1. Нажать "Обновить плейлист" в основном окне
2. Выбрать "Файл M3U"
3. Загрузить .m3u или .m3u8 файл
4. Настроить параметры синхронизации
5. Подтвердить обновление

### Обновление из Spotify
1. Нажать "Обновить плейлист" в основном окне
2. Выбрать "Spotify"
3. Ввести ссылку на плейлист Spotify
4. Настроить параметры синхронизации
5. Подтвердить обновление

### Добавление нового плейлиста
1. Нажать "Добавить плейлист" в сайдбаре
2. Выбрать источник (файл или Spotify)
3. Загрузить файл или ввести ссылку
4. Плейлист будет добавлен автоматически 