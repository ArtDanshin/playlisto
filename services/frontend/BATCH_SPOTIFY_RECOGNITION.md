# Пакетное распознавание треков в Spotify

## Описание

Добавлена возможность автоматического распознавания всех треков плейлиста в Spotify с помощью кнопки "Распознать в Spotify". Функция ищет точные совпадения по паре "Исполнитель - Название трека" и автоматически связывает найденные треки с данными из Spotify.

Также добавлена возможность поиска отдельных треков по Spotify URL в окне редактирования трека.

## Архитектура

### Компоненты
- **`SortableTrackList`** - основной компонент списка треков с drag-and-drop
- **`BatchSpotifyRecognition`** - отдельный компонент для пакетного распознавания с попапом
- **`TrackEditDialog`** - диалог редактирования трека с поиском по URL

### Разделение ответственности
- **SortableTrackList** - управление списком треков, drag-and-drop, редактирование порядка
- **BatchSpotifyRecognition** - логика распознавания, UI попапа, прогресс, результаты
- **TrackEditDialog** - редактирование трека, поиск по названию и URL

## Как использовать

### 1. Авторизация в Spotify
- Нажмите на кнопку "Войти в Spotify" в настройках
- Следуйте инструкциям для авторизации
- После успешной авторизации кнопка "Распознать в Spotify" станет активной

### 2. Пакетное распознавание
- Откройте любой плейлист
- Нажмите кнопку "Распознать в Spotify" рядом с заголовком "Треки"
- Откроется попап с информацией о треках для распознавания
- Нажмите "Начать распознавание"
- Дождитесь завершения процесса (отображается прогресс)
- Просмотрите результаты в том же попапе

### 3. Поиск отдельного трека по URL
- Откройте плейлист
- Нажмите на кнопку редактирования (карандаш) у любого трека
- В окне редактирования найдите секцию "Spotify"
- Вставьте Spotify URL трека в поле "Spotify URL трека"
- Нажмите кнопку с иконкой ссылки
- Выберите найденный трек из результатов
- Сохраните изменения

## Поддерживаемые форматы Spotify URL

- `https://open.spotify.com/track/6vBRAhaSk91csuuWtttPf8?si=69fee5d8fdc84e16`
- `https://open.spotify.com/track/6vBRAhaSk91csuuWtttPf8`
- `spotify:track:6vBRAhaSk91csuuWtttPf8`
- `6vBRAhaSk91csuuWtttPf8` (только ID трека)

## UI/UX особенности

### Кнопка распознавания
- **Неактивна** - если не авторизован в Spotify
- **Неактивна** - если все треки уже связаны со Spotify
- **Показывает количество** - бейдж с числом треков для распознавания
- **Tooltip** - подсказка о состоянии кнопки

### Попап распознавания

#### Состояния попапа:

1. **Требуется авторизация**
   - Иконка AlertCircle
   - Текст о необходимости авторизации

2. **Все треки связаны**
   - Иконка CheckCircle
   - Текст о том, что все треки уже связаны

3. **Готов к распознаванию**
   - Иконка Music
   - Список треков для распознавания
   - Кнопка "Начать распознавание"

4. **В процессе распознавания**
   - Иконка Loader2 (анимированная)
   - Прогресс-бар
   - Текст "Распознаем треки..."

5. **Результаты распознавания**
   - Иконка CheckCircle
   - Список распознанных треков (зеленые)
   - Список не распознанных треков (оранжевые)

### Диалог редактирования трека

#### Поиск по URL:
- Поле ввода для Spotify URL
- Кнопка поиска с иконкой ссылки
- Валидация формата URL
- Обработка ошибок

#### Поиск по названию:
- Кнопка "Найти в Spotify по названию"
- Поиск по исполнителю и названию
- Отображение результатов поиска

#### Разделитель "или":
- Визуальное разделение двух способов поиска
- Понятная навигация для пользователя

### Визуальные индикаторы

#### Распознанные треки:
- ✅ Зеленая иконка CheckCircle
- Зеленый фон
- Текст "Распознанные треки (X)"

#### Не распознанные треки:
- ❌ Оранжевая иконка X
- Оранжевый фон
- Текст "Не распознанные треки (X)"

## Логика работы

### Пакетное распознавание
- Для каждого трека выполняется поиск в Spotify API по запросу "Исполнитель Название"
- Ищутся только **точные совпадения** (без учета регистра)
- Пропускаются треки, уже связанные со Spotify
- Ограничение: 5 результатов поиска для повышения точности

### Поиск по URL
- Извлечение ID трека из Spotify URL
- Прямой запрос к Spotify API по ID трека
- Получение точных данных трека
- Обновление информации трека в плейлисте

### Обработка результатов
При нахождении точного совпадения:
- ✅ Обновляется название трека (из Spotify)
- ✅ Обновляется исполнитель (из Spotify)
- ✅ Обновляется длительность (из Spotify)
- ✅ Сохраняется Spotify ID
- ✅ Сохраняются полные данные трека
- ✅ Загружается и сохраняется обложка альбома в base64

### Защита от перегрузки API
- Задержка 200ms между запросами
- Ограничение до 5 результатов поиска
- Пропуск уже связанных треков
- Обработка ошибок для каждого трека отдельно

## Технические детали

### Функция точного совпадения:
```typescript
const isExactMatch = (track: Track, spotifyTrack: any): boolean => {
  const trackTitle = track.title.toLowerCase().trim();
  const trackArtist = track.artist.toLowerCase().trim();
  const spotifyTitle = spotifyTrack.name.toLowerCase().trim();
  const spotifyArtist = spotifyTrack.artists[0]?.name.toLowerCase().trim();
  
  return trackTitle === spotifyTitle && trackArtist === spotifyArtist;
};
```

### Извлечение ID из URL:
```typescript
export function extractTrackIdFromUrl(url: string): string | null {
  // Поддержка различных форматов Spotify URL
  // Возвращает ID трека или null
}
```

### Процесс распознавания:
1. Проверка авторизации в Spotify
2. Фильтрация треков (только не связанные со Spotify)
3. Отображение списка треков для распознавания
4. Итерация по всем трекам плейлиста
5. Поиск в Spotify API с задержкой
6. Поиск точного совпадения
7. Обновление трека при нахождении совпадения
8. Сохранение обложки альбома
9. Обновление плейлиста в базе данных
10. Отображение результатов

### Процесс поиска по URL:
1. Валидация формата Spotify URL
2. Извлечение ID трека из URL
3. Запрос к Spotify API по ID
4. Получение данных трека
5. Обновление информации трека
6. Сохранение обложки альбома

### Ограничения:
- Требуется авторизация в Spotify
- Только точные совпадения (без нечеткого поиска)
- Максимум 5 результатов поиска на трек
- Задержка 200ms между запросами
- Пропуск треков с ошибками (продолжение процесса)
- Валидация формата Spotify URL

## Преимущества

1. **Разделение ответственности** - логика распознавания вынесена в отдельный компонент
2. **Улучшенный UX** - попап с детальной информацией и прогрессом
3. **Автоматизация** - массовое связывание треков без ручного поиска
4. **Точность** - только 100% совпадения для избежания ошибок
5. **Эффективность** - пропуск уже связанных треков
6. **Безопасность** - защита от перегрузки Spotify API
7. **Прозрачность** - полная информация о результатах распознавания
8. **Гибкость** - поиск как по названию, так и по URL
9. **Удобство** - поддержка различных форматов Spotify URL
10. **Надежность** - валидация URL и обработка ошибок

## Требования

- Авторизация в Spotify API
- Валидный Client ID в переменных окружения
- Интернет-соединение
- Плейлист с треками для распознавания
- Spotify URL трека (для поиска по URL) 